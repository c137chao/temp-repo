import socket
import time
import pickle
import util
import config
import krige_impl 

import numpy as np
from matplotlib import pyplot as plt


points = np.array(
    [
       [165, 215, 0],
       [85, 195, 0], 
       [185, 185, 0], 
       [145, 175, 0], 
       [105, 165, 0], 
       [65, 155, 0], 
       [205, 145, 0],
       [165, 135, 0], 
       [85, 115, 0], 
       [45, 105, 0], 
       [185, 95, 0], 
       [145, 85, 0], 
       [105, 75, 0],
       [65, 65, 0],
       [165, 55, 0],
       [85, 35, 0],
    ])


demo_seqs = np.array(
  [
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1],
    [1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1],
    [1,1,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,1,1,1,1,1,1,1,1,1],
    [1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1],
    [0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0],
    [0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0],
    [0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  ]
)

mask = np.zeros((250, 250),  dtype=bool)
for x in range(mask.shape[0]):
   for y in range(mask.shape[1]):
      mask[x, y] = False
      if util.in_cycle(x, y, 125): 
         mask[x, y] = True
      
print(mask)

def all_water(mtx):
    for x in range(mtx.shape[0]):
        for y in range(mtx.shape[1]):
            r = (x-125)**2 + (y-125)**2
            if r > 125**2:
                mtx[x, y] = 0.5
    mtx[0, 0] = 1

def image_on_fiber(fibers):
    pass


def demo_image_level(seqs):
   fig = plt.figure('frame')

   import liner_image

   mtx = np.zeros((250, 250))
   water_mtx = np.zeros((250, 250))
   all_water(water_mtx)
   for i in range(seqs.shape[1]):
      for j in (range(16)):
        points[j][2] = seqs[j][i]
      liner_image.imagine_layer(points, 125, mtx)
      # slow display
      ax1 = fig.add_subplot(1, 1, 1)
      ax1.imshow(mtx, origin="lower", cmap='bwr')
      ax1.scatter(points[:,0], points[:,1], c=points[:,2])
      # plt.show()
      plt.pause(0.1)
      fig.clf()

x = np.arange(1, 250+1)
y = np.arange(1, 64+1)

pipe_scatter = []
from mpl_toolkits.mplot3d import Axes3D

def demo_image_wave(seqs):
  x_range = 250
  y_range = 250
  range_step = 1
  gridx = np.arange(0.0, x_range, range_step)
  gridy = np.arange(0.0, y_range, range_step)
 
  mtx = np.zeros((250, 250))
  water_mtx = np.zeros((250, 250))
  all_water(water_mtx)
#   fig = plt.figure('frame')
  for i in range(seqs.shape[1]):
    points[:,2] = seqs[:,i]
    # for j in (range(16)):
    #   points[j][2] = seqs[j][i]
    if not np.any(points[:,2]):
      mtx = water_mtx
    else:
      kg = krige_impl.Kriging(points[:,0], points[:,1], points[:,2], nlags=10,)
      mtx, _ = kg.execute('grid', gridx, gridy)
      util.set_range(mtx)
    
    # pipe_scatter.append(np.count_nonzero(mtx, axis=0))

    # slow display
    # ax1 = fig.add_subplot(1, 1, 1)
    # ax1.imshow(mtx, origin="lower", cmap='bwr')
    # ax1.scatter(points[:,0], points[:,1], c=points[:,2])
    # plt.pause(0.001)
    # fig.clf()


def main(): 
    start = time.perf_counter()
    demo_image_wave(demo_seqs)
    end = time.perf_counter()
    print("runtime:", end-start)

# Using the special variable  
# __name__ 
if __name__=="__main__": 
    main() 